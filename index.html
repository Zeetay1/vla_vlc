<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Positivity Summit Check-In</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #reader { width: 300px; margin: 0 auto; }
    #result { margin-top: 20px; font-size: 1.2em; font-weight: bold; }
    .success { color: green; }
    .error { color: red; }
    #log { margin-top: 40px; text-align: left; max-width: 700px; margin-left: auto; margin-right: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h2>Visionnaire Leadership Conference Check-In</h2>
  <div id="reader"></div>
  <div id="result">Scan a QR code to check in</div>
  <div id="log">
    <h3>Check-in Log</h3>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Pass Type</th>
          <th>Status</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="log-body"></tbody>
    </table>
  </div>

  <script>
    const tbody = document.getElementById("log-body");

    function appendLog(name, passType, status, time) {
      // Prevent duplicates: check if row already exists
      const existingRow = Array.from(tbody.rows).find(
        row => row.cells[0].textContent.trim().toLowerCase() === name.trim().toLowerCase()
      );

      if (existingRow) {
        existingRow.cells[1].textContent = passType;
        existingRow.cells[2].textContent = status;
        existingRow.cells[3].textContent = time;
      } else {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = name;
        row.insertCell(1).textContent = passType;
        row.insertCell(2).textContent = status;
        row.insertCell(3).textContent = time;
      }
    }

    function processScannedName(name) {
      const payload = new URLSearchParams();
      payload.append("name", name);

      fetch("https://script.google.com/macros/s/AKfycbwuhW7DW3HeeVVZabnP2weOlmNelxsXxOoX1ySD-4h84IIX3crW_imxYgmYwZToeeLliQ/exec", {
        method: "POST",
        body: payload
      })
      .then(res => res.json())
      .then(data => {
        console.log("Backend response:", data); // Debugging line
        const resultDiv = document.getElementById("result");
        resultDiv.textContent = data.message;
        resultDiv.className = data.success ? "success" : "error";

        if (data.success) {
          appendLog(
            data.name,
            data.passType,
            "✅ Checked in",
            new Date(data.time).toLocaleString()
          );
        } else if (data.name) {
          // If already checked in, still update the log with correct info
          appendLog(
            data.name,
            data.passType || "",
            "Already checked in",
            new Date().toLocaleString()
          );
        }
      })
      .catch(err => {
        document.getElementById("result").textContent = "⚠️ Error: " + err;
        document.getElementById("result").className = "error";
      });
    }

    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: 250 };

    function startScanner() {
      html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          html5QrCode.stop().then(() => {
            processScannedName(decodedText);
            setTimeout(startScanner, 3000);
          });
        },
        (errorMessage) => { /* ignore scan errors */ }
      ).catch(err => {
        document.getElementById("result").textContent = "Camera error: " + err;
      });
    }

    startScanner();
  </script>
</body>
</html>
